<?php
/*
    This file is part of Camdram.

    Camdram is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    Camdram is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Camdram; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
    
    Copyright (c) 2006-2012. See the AUTHORS file for a list of authors.
*/

/**
* Takes site structure from database and writes it to a PHP file. This happens on access periodically, or when the site structure is changed from the admin menu.
* @return none
*/

function GenerateLinkCache () {
	global $cachefile, $adcdb;
	$query = "SELECT * FROM acts_pages ORDER BY acts_pages.id";
	$ret = sqlQuery ($query, $adcdb);
	$cache_used_urls = array();
	if ($ret > 0)
	{
		$titles = array();
		$usepages = array();
		$cache_link_ids = "\$cache_link_id = array (";
                $cache_link_ids_to_nice_url = "\$cache_link_id_to_nice_url = array(";
                $cache_link_niceurls = "\$cache_link_niceurls = array(";
		$cache_link_titles = "\$cache_link_title = array (";
		$cache_link_usepages = "\$cache_link_usepage = array (";
		$cache_link_micros = "\$cache_link_micro = array (";
		$cache_link_virtuals = "\$cache_link_virtual = array (";
		$cache_link_parsers = "\$cache_link_parser = array(";
		while ($row = mysql_fetch_assoc ($ret)) {
			$cache_link_ids .= "'" . $row['id'] . "' => '" . addslashes ($row['title']) . "', \n";
                        $nice_url = id_to_url($row['id']);
                        if (!array_key_exists ($nice_url, $cache_used_urls))
                        {
	                        $cache_link_ids_to_nice_url .= "'" . $row['id'] . "' => '" . addslashes ($nice_url) . "', \n";
	                        $cache_link_niceurls .= "'" . addslashes($nice_url) . "' => '" . $row['id'] . "', \n";
	                        $cache_used_urls[$nice_url] = 1;
	                }
			if (! ( array_key_exists($row['title'], $titles) && $titles[$row['title']] == 1 )) {
				$cache_link_titles .= "'" . addslashes ($row['title']) . "' => '" . $row['id'] . "', \n";
				$titles[$row['title']] = 1;
			}
			if ($row['usepage'] != "" && !(array_key_exists($row['usepage'], $usepages) && $usepages[$row['usepage']] == 1) ) {
				$cache_link_usepages .= "'" . $row['usepage'] . "' => '" . $row['id'] . "', \n";
				$usepages[$row['usepage']] = 1;
			}
			$cache_link_micros .= "'" . $row['id'] . "' => '" . $row['micro'] . "', \n";
			$cache_link_virtuals .= "'" . $row['id'] . "' => '" . $row['virtual'] . "', \n";
			$cache_link_parsers .= "'" . $row['id'] . "' => '" . $row['param_parser'] . "', \n";
		}
		$cache_link_ids .= ");\n";
		$cache_link_ids_to_nice_url .= ");\n";
		$cache_link_niceurls .= ");\n";
		$cache_link_titles .= ");\n";
		$cache_link_usepages .= ");\n";
		$cache_link_micros .= ");\n";
		$cache_link_virtuals .= ");\n";
		$cache_link_parsers .= ");\n";
	}
	
	fwrite ($cachefile, $cache_link_ids);
	fwrite ($cachefile, $cache_link_ids_to_nice_url);
	fwrite ($cachefile, $cache_link_niceurls);
	fwrite ($cachefile, $cache_link_titles);
	fwrite ($cachefile, $cache_link_usepages);
	fwrite ($cachefile, $cache_link_micros);
	fwrite ($cachefile, $cache_link_virtuals);
	fwrite ($cachefile, $cache_link_parsers);
	mysql_free_result ($ret);
}

/**
* Loads cache file generated by GenerateLinkCache, triggering regeneration if either the file doesn't exist or it is over 5 minutes old.
* @return none
*/

function LoadCaches () {
	global $cache_link_id, $cache_link_id_to_nice_url, $cache_link_niceurls, $cache_link_title, $cache_link_usepage, $cache_link_micro, $cache_link_virtual, $cache_link_parser;
	if (!file_exists (getcwd() . "/data/cache.php"))
		RegenerateCaches();
	if (time() > filemtime (getcwd() . "/data/cache.php") + 5 * 60)
		RegenerateCaches();
	
	include_once (getcwd() . "/data/cache.php");
}

/**
  * Called to regenerate cache file - creates new file, calls GenerateLinkCache and deletes old one
  * @return none
  */

function RegenerateCaches() {
		global $cachefile;
                $cachefile = fopen (getcwd() . "/data/cache-new.php", "w");
		if(!$cachefile)
		      die("Could not write to /data - check permissions");
                fwrite ($cachefile, "<?php\n");
                GenerateLinkCache();
                fwrite ($cachefile, "?>\n");
                fclose ($cachefile);
		rename (getcwd() . "/data/cache-new.php", getcwd() . "/data/cache.php");
}

?>
